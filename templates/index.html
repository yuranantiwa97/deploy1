<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Sistem Rekomendasi Restoran Yogyakarta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f5f6fa; }
    .container { max-width: 1100px; }
    .rating-star { color: #ffc107; }
    .filter-label { font-weight: 500; margin-bottom: 2px; }
    .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .pill a { text-decoration:none }
  </style>
</head>
<body>
  <nav class="navbar navbar-light bg-primary mb-4">
    <div class="container">
      <span class="navbar-brand mb-0 h1 text-white">Rekomendasi Restoran Yogyakarta</span>
    </div>
  </nav>

  <div class="container pb-4">

    <!-- ==== Filter & Pengaturan (disederhanakan) ==== -->
    <div class="card shadow-sm p-4 mb-4">
      <h5 class="mb-3">Filter & Pengaturan</h5>

      <form method="GET" action="/">
        <div class="row g-3">
          <!-- Nama -->
          <div class="col-md-6">
            <label class="filter-label">Nama Restoran</label>
            <input type="text" class="form-control" name="nama" placeholder="Cari nama restoran..."
                   value="{{ request.values.get('nama','') }}" />
          </div>

          <!-- Jenis -->
          <div class="col-md-6">
            <label class="filter-label">Jenis Makanan</label>
            <select class="form-select" name="jenis">
              <option value="">Semua Jenis</option>
              {% for jenis in jenis_list %}
                <option value="{{ jenis }}" {{ 'selected' if request.values.get('jenis','')==jenis else '' }}>
                  {{ jenis }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- Daerah -->
          <div class="col-md-6">
            <label class="filter-label">Daerah</label>
            <select class="form-select" name="daerah">
              <option value="">Semua</option>
              {% for a in area_list %}
                <option value="{{ a }}" {{ 'selected' if selected_daerah==a else '' }}>{{ a }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Harga -->
          <div class="col-md-6">
            <label class="filter-label">Harga (Rp): <span id="harga-range"></span></label>
            <input type="range" class="form-range" name="harga_min"
                   min="{{ harga_min }}" max="{{ harga_max }}"
                   value="{{ harga_min_req or harga_min }}" step="1000" id="rangeHargaMin" />
            <input type="range" class="form-range" name="harga_max"
                   min="{{ harga_min }}" max="{{ harga_max }}"
                   value="{{ harga_max_req or harga_max }}" step="1000" id="rangeHargaMax" />
          </div>

          <!-- Rating -->
          <div class="col-md-6">
            <label class="filter-label">Rating: <span id="rating-range"></span></label>
            <input type="range" class="form-range" name="rating_min"
                   min="{{ rating_min }}" max="{{ rating_max }}"
                   value="{{ rating_min_req or rating_min }}" step="0.1" id="rangeRatingMin" />
            <input type="range" class="form-range" name="rating_max"
                   min="{{ rating_min }}" max="{{ rating_max }}"
                   value="{{ rating_max_req or rating_max }}" step="0.1" id="rangeRatingMax" />
          </div>

          <!-- Algoritma + k -->
          <div class="col-md-6">
            <label class="filter-label">Algoritma</label>
            <div class="input-group">
              <select class="form-select" name="algo">
                <option value="kmeans"    {{ 'selected' if algo=='kmeans' else '' }}>K-Means</option>
                <option value="meanshift" {{ 'selected' if algo=='meanshift' else '' }}>MeanShift</option>
              </select>
              <input type="number" class="form-control" name="k" min="2" max="8" step="1"
                     value="{{ k }}" {{ 'disabled' if algo!='kmeans' or k_auto else '' }} placeholder="k (K-Means)">
              <span class="input-group-text">
                <input class="form-check-input mt-0" type="checkbox" name="k_auto" value="1"
                       {{ 'checked' if k_auto else '' }} {{ 'disabled' if algo!='kmeans' else '' }}>
                <span class="ms-2">Auto (2–6)</span>
              </span>
            </div>
            <div class="form-text">K-Means: pilih k manual atau centang Auto. MeanShift: jumlah cluster otomatis.</div>
          </div>

          <div class="col-md-12 text-end mt-2">
            <button type="submit" class="btn btn-primary">Terapkan</button>
          </div>
        </div>
      </form>
    </div>

    <!-- ==== Panel Training & Evaluasi ==== -->
    <div class="card shadow-sm p-3 mb-4">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div class="d-flex align-items-center gap-2">
          <span>Status:</span>
          {% if trained %}<span class="badge text-bg-success">Setelah Training</span>{% else %}<span class="badge text-bg-secondary">Sebelum Training</span>{% endif %}
          <span class="ms-3">Algoritma:</span>
          <span class="badge text-bg-info text-dark">
            {{ 'K-Means' if algo=='kmeans' else 'MeanShift' }}
            {% if metrics.k_mode=='auto' %}(Auto; k terbaik={{ metrics.best_k }}){% elif metrics.k %}(k={{ metrics.k }}){% endif %}
          </span>
        </div>

        <div class="d-flex flex-wrap gap-2">
          <!-- Train -->
          <form method="POST" action="/train" class="d-inline">
            <!-- bawa filter yang relevan -->
            <input type="hidden" name="nama"        value="{{ request.values.get('nama','') }}">
            <input type="hidden" name="jenis"       value="{{ request.values.get('jenis','') }}">
            <input type="hidden" name="daerah"      value="{{ selected_daerah }}">
            <input type="hidden" name="harga_min"   value="{{ harga_min_req }}">
            <input type="hidden" name="harga_max"   value="{{ harga_max_req }}">
            <input type="hidden" name="rating_min"  value="{{ rating_min_req }}">
            <input type="hidden" name="rating_max"  value="{{ rating_max_req }}">
            <input type="hidden" name="algo"  value="{{ algo }}">
            <input type="hidden" name="k"     value="{{ k }}">
            <input type="hidden" name="k_auto" value="{{ '1' if k_auto else '' }}">
            <button type="submit" class="btn btn-outline-primary">Train (pakai filter ini)</button>
          </form>

          <!-- Reset -->
          <form method="POST" action="/reset" class="d-inline">
            <input type="hidden" name="nama"        value="{{ request.values.get('nama','') }}">
            <input type="hidden" name="jenis"       value="{{ request.values.get('jenis','') }}">
            <input type="hidden" name="daerah"      value="{{ selected_daerah }}">
            <input type="hidden" name="harga_min"   value="{{ harga_min_req }}">
            <input type="hidden" name="harga_max"   value="{{ harga_max_req }}">
            <input type="hidden" name="rating_min"  value="{{ rating_min_req }}">
            <input type="hidden" name="rating_max"  value="{{ rating_max_req }}">
            <input type="hidden" name="algo"  value="{{ algo }}">
            <input type="hidden" name="k"     value="{{ k }}">
            <input type="hidden" name="k_auto" value="{{ '1' if k_auto else '' }}">
            <button type="submit" class="btn btn-outline-secondary">Reset</button>
          </form>
        </div>
      </div>

      <!-- Metrik -->
      <div class="row g-3 mt-2">
        <div class="col-md-4">
          <div class="p-2 border rounded bg-white">
            <div class="small text-muted">Silhouette Score</div>
            <div class="fs-5 fw-semibold mono">
              {% if metrics_view.silhouette is not none %}{{ '%.3f'|format(metrics_view.silhouette) }}{% else %}n/a{% endif %}
            </div>
            {% if metrics_view.sil_quality %}<span class="badge text-bg-{{ metrics_view.sil_badge }} mt-1">{{ metrics_view.sil_quality }}</span>{% endif %}
          </div>
        </div>
        <div class="col-md-4">
          <div class="p-2 border rounded bg-white">
            <div class="small text-muted">Davies–Bouldin Index</div>
            <div class="fs-5 fw-semibold mono">
              {% if metrics_view.dbi is not none %}{{ '%.3f'|format(metrics_view.dbi) }}{% else %}n/a{% endif %}
            </div>
            {% if metrics_view.dbi_quality %}<span class="badge text-bg-{{ metrics_view.dbi_badge }} mt-1">{{ metrics_view.dbi_quality }}</span>{% endif %}
          </div>
        </div>
        <div class="col-md-4">
          <div class="p-2 border rounded bg-white">
            <div class="small text-muted">Sampel Dilatih</div>
            <div class="fs-5 fw-semibold mono">{{ metrics.n or 0 }}</div>
          </div>
        </div>
      </div>

      {% if trained and metrics.k_mode == 'auto' and list_k %}
        <div class="mt-2 d-flex align-items-center gap-2">
          <div class="small text-muted">Silhouette/DBI per k:</div>
          <form method="GET" action="/" class="d-flex align-items-center gap-2">
            {% for key, val in request.values.items() %}
              {% if key not in ['view_k'] %}
                <input type="hidden" name="{{ key }}" value="{{ val }}">
              {% endif %}
            {% endfor %}
            <select class="form-select form-select-sm" name="view_k" style="width:auto" onchange="this.form.submit()">
              {% for kopt in list_k %}
                <option value="{{ kopt }}" {{ 'selected' if view_k==kopt else '' }}>k={{ kopt }}</option>
              {% endfor %}
            </select>
            <noscript><button class="btn btn-sm btn-outline-secondary">Lihat</button></noscript>
          </form>
        </div>
      {% endif %}

      {% if trained and metrics_view.profiles %}
        <div class="mt-3">
          <h6 class="mb-2">Profil Cluster (subset ini{% if metrics.k_mode=='auto' and metrics_view.k_view %}; k={{ metrics_view.k_view }}{% endif %})</h6>
          <div class="table-responsive">
            <table class="table table-sm table-bordered align-middle">
              <thead>
                <tr>
                  <th>No</th>
                  <th>Nama</th>
                  <th>n</th>
                  <th>Rata-rata Harga</th>
                  <th>Rata-rata Rating</th>
                </tr>
              </thead>
              <tbody>
                {% for p in metrics_view.profiles %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>{{ metrics_view.cluster_name_map[p.id] if metrics_view.cluster_name_map else ('Cluster ' ~ p.id) }}</td>
                  <td>{{ p.n }}</td>
                  <td>{{ p.mean_price | round(0) | int | rupiah }}</td>
                  <td>{{ '%.2f'|format(p.mean_rating) }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="small text-muted">Penamaan segmen diurut dari harga rata-rata terendah → tertinggi.</div>
        </div>
      {% endif %}

      {% if trained and metrics_view.scatter_b64 %}
        <div class="mt-3">
          <h6 class="mb-2">Visualisasi (Harga vs Rating{% if metrics.k_mode=='auto' and metrics_view.k_view %}; k={{ metrics_view.k_view }}{% endif %})</h6>
          <img class="img-fluid rounded border" alt="scatter" src="data:image/png;base64, {{ metrics_view.scatter_b64 }}">
        </div>
      {% endif %}
    </div>

    <!-- ==== Hasil + Filter Tier (H/M/P) ==== -->
    {% if hasil is defined %}
      <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
        <h5 class="mb-0">
          Hasil ({{ total_count }}) — menampilkan {{ start_idx }}–{{ end_idx }}
          {% if trained %}<span class="badge text-bg-success ms-2">Setelah Training</span>{% else %}<span class="badge text-bg-secondary ms-2">Sebelum Training</span>{% endif %}
        </h5>

<!-- Chip filter tier -->
<div class="d-flex gap-2 pill">
  <a class="btn btn-sm {{ 'btn-primary' if not tier_view else 'btn-outline-primary' }}"
     href="{{ url_for('index',
                      nama=request.values.get('nama',''),
                      jenis=request.values.get('jenis',''),
                      daerah=selected_daerah,
                      harga_min=harga_min_req, harga_max=harga_max_req,
                      rating_min=rating_min_req, rating_max=rating_max_req,
                      algo=algo, k=k, k_auto=('1' if k_auto else ''),
                      tier_view='', page=1) }}">
    Semua
  </a>
  <a class="btn btn-sm {{ 'btn-primary' if tier_view=='Hemat' else 'btn-outline-primary' }}"
     href="{{ url_for('index',
                      nama=request.values.get('nama',''),
                      jenis=request.values.get('jenis',''),
                      daerah=selected_daerah,
                      harga_min=harga_min_req, harga_max=harga_max_req,
                      rating_min=rating_min_req, rating_max=rating_max_req,
                      algo=algo, k=k, k_auto=('1' if k_auto else ''),
                      tier_view='Hemat', page=1) }}">
    Hemat
  </a>
  <a class="btn btn-sm {{ 'btn-primary' if tier_view=='Menengah' else 'btn-outline-primary' }}"
     href="{{ url_for('index',
                      nama=request.values.get('nama',''),
                      jenis=request.values.get('jenis',''),
                      daerah=selected_daerah,
                      harga_min=harga_min_req, harga_max=harga_max_req,
                      rating_min=rating_min_req, rating_max=rating_max_req,
                      algo=algo, k=k, k_auto=('1' if k_auto else ''),
                      tier_view='Menengah', page=1) }}">
    Menengah
  </a>
  <a class="btn btn-sm {{ 'btn-primary' if tier_view=='Premium' else 'btn-outline-primary' }}"
     href="{{ url_for('index',
                      nama=request.values.get('nama',''),
                      jenis=request.values.get('jenis',''),
                      daerah=selected_daerah,
                      harga_min=harga_min_req, harga_max=harga_max_req,
                      rating_min=rating_min_req, rating_max=rating_max_req,
                      algo=algo, k=k, k_auto=('1' if k_auto else ''),
                      tier_view='Premium', page=1) }}">
    Premium
  </a>
</div>


      </div>

      <div class="table-responsive mb-3">
        <table class="table table-striped table-hover align-middle">
          <thead>
            <tr>
              <th>No</th>
              <th>Nama Restoran</th>
              <th>Jenis Makanan</th>
              <th>Harga (Rp)</th>
              <th>Rating</th>
              <th>Daerah</th>
              {% if trained %}<th>Cluster</th>{% endif %}
              <th>Maps</th>
            </tr>
          </thead>
          <tbody>
            {% for row in hasil %}
            <tr>
              <td>{{ loop.index + (start_idx - 1) }}</td>
              <td>{{ row['Nama Restoran'] }}</td>
              <td>{{ row.get('Preferensi Makanan','') }}</td>
              <td>{{ row['Harga Rata-Rata Makanan di Toko (Rp)'] | rupiah }}</td>
              <td>
                {% set rating_val = row['Rating Toko'] %}
                {% set rating_int = (rating_val or 0)|int %}
                {% for _ in range(rating_int) %}<span class="rating-star">&#9733;</span>{% endfor %}
                <span class="ms-1 small">({{ rating_val }})</span>
              </td>
              <td>{{ row.get('_area_ui') or '-' }}</td>
              {% if trained %}
                <td>
                  {% set cid = row.get('cluster_kmeans') %}
                  {% if cid is not none %}
                    {{ metrics_view.cluster_name_map[cid] if metrics_view.cluster_name_map and cid in metrics_view.cluster_name_map else ('Cluster ' ~ cid) }}
                  {% else %}-{% endif %}
                </td>
              {% endif %}
              <td>
                {% set mlink = row.get('maps_link') %}
                {% if not mlink %}
                  {% set q = (row['Nama Restoran'] ~ ' ' ~ (row.get('_area_ui') or 'Yogyakarta')) | urlencode %}
                  {% set mlink = 'https://www.google.com/maps/search/?api=1&query=' ~ q %}
                {% endif %}
                <a href="{{ mlink }}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-secondary">Buka</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Paginasi -->
      <div class="d-flex justify-content-end gap-2">
        {% if prev_url %}<a class="btn btn-sm btn-outline-secondary" href="{{ prev_url }}">&laquo; Sebelumnya</a>{% endif %}
        {% if next_url %}<a class="btn btn-sm btn-outline-secondary" href="{{ next_url }}">Berikutnya &raquo;</a>{% endif %}
      </div>
    {% endif %}
  </div>

  <script>
    // label slider
    const toRp = n => 'Rp ' + (parseInt(n||0,10)).toLocaleString('id-ID');
    document.addEventListener('DOMContentLoaded', () => {
      const hargaMin = document.getElementById('rangeHargaMin');
      const hargaMax = document.getElementById('rangeHargaMax');
      const ratingMin = document.getElementById('rangeRatingMin');
      const ratingMax = document.getElementById('rangeRatingMax');
      const hargaLabel = document.getElementById('harga-range');
      const ratingLabel = document.getElementById('rating-range');

      const updateHarga  = () => { if (hargaLabel)  hargaLabel.textContent  = toRp(hargaMin.value) + ' - ' + toRp(hargaMax.value); };
      const updateRating = () => { if (ratingLabel) ratingLabel.textContent = ratingMin.value + ' - ' + ratingMax.value; };

      if (hargaMin && hargaMax) { hargaMin.oninput = updateHarga;  hargaMax.oninput = updateHarga;  updateHarga(); }
      if (ratingMin && ratingMax){ ratingMin.oninput = updateRating; ratingMax.oninput = updateRating; updateRating(); }
    });
  </script>
</body>
</html>
