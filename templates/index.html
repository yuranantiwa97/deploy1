<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Sistem Rekomendasi Restoran Yogyakarta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f5f6fa; }
    .container { max-width: 900px; }
    .rating-star { color: #ffc107; }
    .filter-label { font-weight: 500; margin-bottom: 2px; }
  </style>
</head>
<body>
  <nav class="navbar navbar-light bg-primary mb-4">
    <div class="container">
      <span class="navbar-brand mb-0 h1 text-white">Rekomendasi Restoran Yogyakarta</span>
    </div>
  </nav>

  <div class="container pb-4">
    <!-- ==== Panel Training & Evaluasi ==== -->
    <div class="card shadow-sm p-3 mb-4">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
          <span class="me-2">Status:</span>
          {% if trained %}
            <span class="badge text-bg-success">Sudah Dilatih</span>
          {% else %}
            <span class="badge text-bg-secondary">Belum Dilatih (Sebelum Training)</span>
          {% endif %}
        </div>

        <div class="d-flex gap-2">
          <form method="POST" action="/train">
            <button type="submit" class="btn btn-outline-primary">Train KMeans</button>
          </form>
          <form method="POST" action="/reset">
            <button type="submit" class="btn btn-outline-secondary">Reset (Sebelum Training)</button>
          </form>
        </div>
      </div>

      <!-- Metrik evaluasi -->
      <div class="mt-3">
        <h6 class="mb-2">Evaluasi (setelah training)</h6>
        {% if trained and metrics and (metrics.silhouette is not none or metrics.dbi is not none) %}
          <div class="row g-3">
            <div class="col-md-4">
              <div class="p-2 border rounded bg-white">
                <div class="small text-muted">Silhouette Score</div>
                <div class="fs-5 fw-semibold">
                  {{ "%.3f"|format(metrics.silhouette) if metrics.silhouette is not none else "n/a" }}
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="p-2 border rounded bg-white">
                <div class="small text-muted">Davies-Bouldin Index</div>
                <div class="fs-5 fw-semibold">
                  {{ "%.3f"|format(metrics.dbi) if metrics.dbi is not none else "n/a" }}
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="p-2 border rounded bg-white">
                <div class="small text-muted">Sampel Dilatih</div>
                <div class="fs-5 fw-semibold">{{ metrics.n }}</div>
              </div>
            </div>
          </div>
        {% else %}
          <div class="alert alert-info mb-0">
            Belum ada metrik. Klik <b>Train KMeans</b> untuk melatih dan menampilkan Silhouette & DBI.
          </div>
        {% endif %}
      </div>
    </div>

    <!-- ==== Filter ==== -->
    <div class="card shadow-sm p-4 mb-4">
      <h5 class="mb-3">Filter Rekomendasi</h5>

      <form method="GET" action="/">
        <div class="row g-3">
          <!-- Nama -->
          <div class="col-md-6">
            <label class="filter-label">Nama Restoran</label>
            <input type="text" class="form-control" name="nama" placeholder="Cari nama restoran..."
                   value="{{ request.values.get('nama','') }}" />
          </div>

          <!-- Jenis -->
          <div class="col-md-6">
            <label class="filter-label">Jenis Makanan</label>
            <select class="form-select" name="jenis">
              <option value="">Semua Jenis</option>
              {% for jenis in jenis_list %}
                <option value="{{ jenis }}" {{ 'selected' if request.values.get('jenis','')==jenis else '' }}>
                  {{ jenis }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- Harga -->
          <div class="col-md-6">
            <label class="filter-label">Harga (Rp): <span id="harga-range"></span></label>
            <input type="range" class="form-range" name="harga_min"
                   min="{{ harga_min }}" max="{{ harga_max }}"
                   value="{{ harga_min_req or harga_min }}" step="1000" id="rangeHargaMin" />
            <input type="range" class="form-range" name="harga_max"
                   min="{{ harga_min }}" max="{{ harga_max }}"
                   value="{{ harga_max_req or harga_max }}" step="1000" id="rangeHargaMax" />
          </div>

          <!-- Rating -->
          <div class="col-md-6">
            <label class="filter-label">Rating: <span id="rating-range"></span></label>
            <input type="range" class="form-range" name="rating_min"
                   min="{{ rating_min }}" max="{{ rating_max }}"
                   value="{{ rating_min_req or rating_min }}" step="0.1" id="rangeRatingMin" />
            <input type="range" class="form-range" name="rating_max"
                   min="{{ rating_min }}" max="{{ rating_max }}"
                   value="{{ rating_max_req or rating_max }}" step="0.1" id="rangeRatingMax" />
          </div>

          <!-- Kategori (label unik) -->
          <div class="col-md-12">
            <label class="filter-label">Kategori rekomendasi (opsional)</label>
            <select class="form-select" name="cluster_label">
              <option value="">Semua kategori</option>
              {% for lab in tier_options %}
                <option value="{{ lab }}" {{ 'selected' if lab == selected_cluster_label else '' }}>
                  {{ lab }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-12 text-end mt-2">
            <button type="submit" class="btn btn-primary">Tampilkan Rekomendasi</button>
          </div>
        </div>
      </form>
    </div>

    {% if hasil is defined %}
      <h5 class="mb-2">
        Hasil Rekomendasi ({{ total_count }}) â€” menampilkan {{ limit }} pertama
        {% if trained %}<span class="badge text-bg-success ms-2">Setelah Training</span>{% else %}<span class="badge text-bg-secondary ms-2">Sebelum Training</span>{% endif %}
      </h5>

      {% if hasil %}
      <div class="table-responsive mb-5">
        <table class="table table-striped table-hover align-middle">
          <thead>
            <tr>
              <th>No</th>
              <th>Nama Restoran</th>
              <th>Jenis Makanan</th>
              <th>Harga (Rp)</th>
              <th>Rating</th>
              <th>Kategori</th>
              {% if trained %}
                <th>Cluster (KMeans)</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for row in hasil %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ row['Nama Restoran'] }}</td>
              <td>{{ row['Preferensi Makanan'] }}</td>
              <td>{{ row['Harga Rata-Rata Makanan di Toko (Rp)'] | rupiah }}</td>
              <td>
                {% set rating_val = row['Rating Toko'] %}
                {% set rating_int = (rating_val or 0)|int %}
                {% for _ in range(rating_int) %}<span class="rating-star">&#9733;</span>{% endfor %}
                <span class="ms-1 small">({{ rating_val }})</span>
              </td>
              <td>{{ row['tier_label'] }}</td>
              {% if trained %}
                <td>
                  {% if row['cluster_kmeans'] is not none %}
                    {{ row['cluster_kmeans'] }}
                  {% else %}
                    -
                  {% endif %}
                </td>
              {% endif %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="alert alert-warning">Tidak ada restoran yang cocok dengan filter.</div>
      {% endif %}
    {% endif %}
  </div>

  <script>
    // label slider
    const toRp = n => 'Rp ' + (parseInt(n||0,10)).toLocaleString('id-ID');
    document.addEventListener('DOMContentLoaded', () => {
      const hargaMin = document.getElementById('rangeHargaMin');
      const hargaMax = document.getElementById('rangeHargaMax');
      const ratingMin = document.getElementById('rangeRatingMin');
      const ratingMax = document.getElementById('rangeRatingMax');
      const hargaLabel = document.getElementById('harga-range');
      const ratingLabel = document.getElementById('rating-range');

      const updateHarga  = () => { if (hargaLabel)  hargaLabel.textContent  = toRp(hargaMin.value) + ' - ' + toRp(hargaMax.value); };
      const updateRating = () => { if (ratingLabel) ratingLabel.textContent = ratingMin.value + ' - ' + ratingMax.value; };

      if (hargaMin && hargaMax) { hargaMin.oninput = updateHarga;  hargaMax.oninput = updateHarga;  updateHarga(); }
      if (ratingMin && ratingMax){ ratingMin.oninput = updateRating; ratingMax.oninput = updateRating; updateRating(); }
    });
  </script>
</body>
</html>
